{% extends 'base.html' %}
{% block content %}
<div class="container text-center" style="padding:50px;">
  <h2>Proceed with Payment</h2>
  <p>Amount to pay: <strong>â‚¹{{ total }}</strong></p>
  <p>Please click below to complete your payment securely.</p>
  <button id="rzp-button1" class="btn btn-dark btn-lg">Pay Now</button>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
var options = {
    "key": "{{ razorpay_key_id }}", // Razorpay key ID
    "amount": "{{ amount }}",       // Amount in paisa
    "currency": "INR",
    "name": "Modeva Store",
    "description": "Online Payment",
    "order_id": "{{ razorpay_order_id }}", // Razorpay order ID
    "handler": function (response){
        // When payment succeeds, verify it on Django side
        fetch("{% url 'payment_verify' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                "razorpay_order_id": response.razorpay_order_id,
                "razorpay_payment_id": response.razorpay_payment_id,
                "razorpay_signature": response.razorpay_signature,
                "order_id": "{{ order_id }}"
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                window.location.href = "{% url 'order_success' %}";
            } else {
                alert("Payment verification failed. Please try again.");
            }
        });
    },
    "prefill": {
        "name": "{{ user_name }}",
        "email": "{{ email }}",
        "contact": "{{ phone }}"
    },
    "theme": {
        "color": "#e91e63"
    }
};

// Open Razorpay popup
var rzp1 = new Razorpay(options);
document.getElementById('rzp-button1').onclick = function(e){
    rzp1.open();
    e.preventDefault();
}
</script>
{% endblock %}
